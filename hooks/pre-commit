#!/bin/bash

# Pre-commit hook for Orus development
# Runs performance regression tests to catch performance issues early

echo "ğŸ” Running pre-commit performance checks..."
echo "ğŸ’¡ Note: Cold start optimization is active - global dispatch table eliminates initial delays"

# Change to the repository root
cd "$(git rev-parse --show-toplevel)"

# Check if Orus is built
if [ ! -f "orus" ]; then
    echo "âš ï¸  Orus not built. Building now..."
    if ! make > /dev/null 2>&1; then
        echo "âŒ Build failed. Cannot run performance tests."
        exit 1
    fi
fi

# Run performance regression tests
echo "ğŸ“Š Running performance regression tests..."
cd tests/benchmarks

if ./performance_regression_test.sh > /dev/null 2>&1; then
    exit_code=$?
    case $exit_code in
        0)
            echo "âœ… Performance tests passed"
            ;;
        1)
            echo "âš ï¸  Performance warning detected"
            echo "ğŸ“ˆ Run './tests/benchmarks/performance_regression_test.sh' for details"
            echo "ğŸ¤” Consider investigating performance impact before committing"
            # Allow commit with warning
            ;;
        2)
            echo "âŒ Critical performance regression detected!"
            echo "ğŸ“‰ Performance degradation exceeds failure threshold"
            echo "ğŸ› ï¸  Please run './tests/benchmarks/performance_regression_test.sh' for analysis"
            echo "ğŸš« Commit blocked until performance is restored"
            exit 1
            ;;
    esac
else
    echo "âš ï¸  Could not run performance tests"
    echo "ğŸ’¡ Ensure you're in the correct directory and Orus is built"
    # Allow commit if tests can't run
fi

echo "âœ¨ Pre-commit checks complete"